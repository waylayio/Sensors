{"name":"timeseriesQueryData","version":"1.0.12","type":"sensor","script":"function parseISOStringDataInput (input) {\n    const duration = moment.duration(input)\n    return moment().subtract(duration).unix() * 1000\n}\n\nfunction parseTimestamp (timestamp) {\n    if (!isNaN(timestamp))\n        return timestamp\n    if (timestamp && timestamp !== '' && isNaN(timestamp))\n        return parseISOStringDataInput(timestamp)\n}\n\nasync function execute () {\n    const {\n        queryName,\n        window,\n        from,\n        until,\n        removeTimestamp = false\n    } = options.requiredProperties\n    \n    if (!queryName || queryName === '') {\n        send(new Error('No valid queryName supplied'), { observedState : 'Not Collected' })\n        return\n    }\n    \n    const queryOptions = {\n        window,\n        from: parseTimestamp(from),\n        until: parseTimestamp(until)\n    }\n    \n    const response = await waylay.analytics.getQueryData(queryName, queryOptions)\n        .catch(error => send(error, { observedState : 'Not Collected' }))\n\n    const hasData = response && response['data'] && response['data'][0]['columns'] && response['data'][0]['columns'].length > 1\n\n    if (hasData && removeTimestamp === 'true') {\n        response['data'][0]['columns'].shift()\n        response['data'][0]['data'].shift()\n    }\n    \n    send(null, {\n        observedState: hasData ? 'Collected' : 'Not Collected',\n        rawData: hasData ? response['data'][0] : response\n    })\n}\n\nexecute()","metadata":{"author":"Sander Vanhove","description":"Get the data as specified by a certain data query.\n\nYou can specify a window, from and until to control the timeframe that is fetched.\nWhen doing so, keep in mind that you are able to specify only 2 out of these three,\nelse they will overwrite eachother and result in unexpected behaviour.\n\nThe removeTimestamp property will remove the timestamp from the data and columns when it's vaslue is 'true'. This is usefull when passing the result to a BYOML sensor.","iconURL":"https://static.waylay.io/icons/query_designer.png","supportedStates":["Collected","Not Collected"],"requiredProperties":["queryName","window","from","until","removeTimestamp"],"requiredRawData":[],"rawData":[{"parameter":"data","dataType":"object[]"},{"parameter":"columns","dataType":"object[]"}]}}