{
  "name": "findCaseFromSalesForce",
  "version": "1.0.9",
  "type": "sensor",
  "script": "const jsforce = require('jsforce')\nconst pify = require('pify')\nconst _ = require('lodash')\n\nasync function main () {\n  const caseObject = cleanObject({\n    AssetId: options.requiredProperties.assetId,\n    CaseNumber: options.requiredProperties.caseNumber,\n    Subject: options.requiredProperties.subject,\n    Status: options.requiredProperties.status,\n    Priority: options.requiredProperties.priority,\n    AccountId: options.requiredProperties.accountId,\n    Reason: options.requiredProperties.reason,\n    OwnerId: options.requiredProperties.ownerId,\n    Product__c: options.requiredProperties.product__c\n  })\n\n  const conn = await getSalesforceConnection()\n\n  const SfCase = pify(conn.sobject('Case'))\n\n  try {\n    const res = await SfCase.find(caseObject)\n    console.log('res', res)\n    send(null, { observedState: res.length ? 'Found' : 'Not Found', rawData: res[0] })\n  } catch (error) {\n    send(null, { observedState: 'Not Found' })\n  }\n}\n\nasync function getSalesforceConnection () {\n  try {\n    const { access_token: accessToken } = await waylay.hoard.getTokens('salesforce', { scope: 'organisation' })\n\n    if (!accessToken) {\n      throw new Error('No user or token provided via Hoard service')\n    }\n\n    const jsclient = new jsforce.Connection({\n      instanceUrl: 'https://eu26.salesforce.com',\n      accessToken\n    })\n\n    return jsclient\n  } catch (error) {\n    throw new Error(`error: ${error} \\n possible solution: Connect Salesforce through the connections`)\n  }\n}\n\n/**\n * remove empty values in object before sending to salesforce\n */\nfunction cleanObject (object) {\n  return _.reduce(object, (acc, v, k) => {\n    if (v) acc[k] = v\n    return acc\n  }, {})\n}\n\nmain().catch(send)\n",
  "metadata": {
    "author": "",
    "description": "<h4>findCaseFromSalesForce</h4>\n<br>\nCase sensor for SalesForce, AssetId can be waylay resource as well\n<br><br>\n<b>States</b>\n<br>\n<ul>\n    <li>Found</li>\n    <li>Not Found</li>\n</ul>\n<br>\n<b>Raw data</b>\n<ul>\n    <li>Id</li>\n    <li>CaseNumber</li>\n    <li>ContactId</li>\n    <li>AccountId</li>\n    <li>InstallDate</li>\n    <li>AssetId</li>\n    <li>SuppliedName</li>\n    <li>SuppliedEmail</li>\n    <li>SuppliedPhone</li>\n    <li>SuppliedCompany</li>\n    <li>Status</li>\n    <li>Subject</li>\n    <li>Priority</li>\n    <li>Description</li>\n    <li>IsClosed</li>\n    <li>IsEscalated</li>\n    <li>CreatedData</li>\n    <li>CreatedById</li>\n    <li>Product__c</li>\n    <li>SLAViolation__c</li>\n    <li>SLA_Type__c</li>\n</ul>\n<br>\n<b>Properties</b>\n<ul>\n   <li>subject</li>\n   <li>caseNumber</li>\n   <li>status</li>\n   <li>priority</li>\n   <li>assetId</li>\n   <li>accountId</li>\n   <li>reason</li>\n   <li>ownerId</li>\n   <li>product__c</li>\n</ul>",
    "documentationURL": "https://docs.waylay.io/plugins/findcasefromsalesforce/",
    "iconURL": "https://static.waylay.io/plugs/icons/salesforce-find-case.png",
    "supportedStates": [
      "Found",
      "Not Found"
    ],
    "requiredProperties": [
      "assetId",
      "subject",
      "status",
      "priority",
      "accountId",
      "reason",
      "ownerId",
      "product__c",
      "caseNumber"
    ],
    "requiredRawData": [],
    "rawData": [
      {
        "parameter": "Id",
        "dataType": "string"
      },
      {
        "parameter": "CaseNumber",
        "dataType": "string"
      },
      {
        "parameter": "ContactId",
        "dataType": "string"
      },
      {
        "parameter": "AccountId",
        "dataType": "integer"
      },
      {
        "parameter": "InstallDate",
        "dataType": "string"
      },
      {
        "parameter": "AssetId",
        "dataType": "string"
      },
      {
        "parameter": "SuppliedName",
        "dataType": "string"
      },
      {
        "parameter": "SuppliedEmail",
        "dataType": "string"
      },
      {
        "parameter": "SuppliedPhone",
        "dataType": "string"
      },
      {
        "parameter": "SuppliedCompany",
        "dataType": "string"
      },
      {
        "parameter": "Status",
        "dataType": "string"
      },
      {
        "parameter": "Subject",
        "dataType": "string"
      },
      {
        "parameter": "Priority",
        "dataType": "string"
      },
      {
        "parameter": "Description",
        "dataType": "string"
      },
      {
        "parameter": "IsClosed",
        "dataType": "boolean"
      },
      {
        "parameter": "IsEscalated",
        "dataType": "boolean"
      },
      {
        "parameter": "CreatedDate",
        "dataType": "string"
      },
      {
        "parameter": "CreatedById",
        "dataType": "string"
      },
      {
        "parameter": "Product__c",
        "dataType": "string"
      },
      {
        "parameter": "SLAViolation__c",
        "dataType": "string"
      },
      {
        "parameter": "SLA_Type__c",
        "dataType": "string"
      }
    ]
  },
  "dependencies": {
    "jsforce": "^1.10.0",
    "pify": "^5.0.0",
    "lodash": "^4.17.15"
  }
}